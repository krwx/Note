# 部署

IIS 部署的项目使用的端口：443

## 部署原理

Visual Studio 中使用 IIS 进行部署（无论是本地 IIS 还是远程 IIS）的原理，核心在于 **将你的应用程序（ASP.NET Core、ASP.NET MVC/Web Forms 等）配置、复制并集成到 Internet Information Services (IIS) 的工作进程中**，使 IIS 能够作为宿主接收 HTTP 请求并将其转发给你的应用程序处理。以下是其详细原理：

1. **IIS 作为主机和反向代理：**
    * **主机：** IIS 是一个功能强大的 Web 服务器，直接监听特定的网络端口（如 80, 443）。
    * **应用程序池：** IIS 通过“应用程序池”隔离和管理不同的 Web 应用。每个池运行一个或多个工作进程（`w3wp.exe`）。
    * **反向代理：** 对于托管在 IIS 内部的应用程序（尤其是 ASP.NET Core），IIS 主要充当反向代理：
        * 接收来自客户端的 HTTP(S) 请求。
        * 将请求转发给运行在应用程序池工作进程内的你的应用程序。
        * 接收应用程序处理后的响应。
        * 将响应发送回客户端。

2. **部署的本质 - 文件复制与配置：**
    * Visual Studio 的部署功能（通过“发布”操作）的核心任务是 **将应用程序运行所需的文件从开发环境复制到 IIS 指定的物理路径下**，并**配置 IIS 站点和应用程序池**以指向这些文件。
    * **复制的内容包括：**
        * 编译后的程序集（`.dll`, `.exe`）。
        * 静态文件（`.html`, `.css`, `.js`, 图片等）。
        * 配置文件（`web.config`, `appsettings.json`）。
        * Razor 视图文件（对于 MVC/Razor Pages）。
        * 其他应用程序依赖项。
    * **配置的内容包括：**
        * **站点绑定：** 指定 IIS 站点监听的 IP 地址、端口和主机名。
        * **物理路径：** 指定 IIS 从哪个文件夹读取应用程序文件（这就是文件复制到的目标位置）。
        * **应用程序池：**
            * 选择或创建应用程序池。
            * 配置应用程序池的 .NET CLR 版本（对于 ASP.NET Framework）或选择“无托管代码”（对于 ASP.NET Core）。
            * 配置托管管道模式（集成模式 vs 经典模式 - 强烈推荐集成模式）。
            * 配置身份标识（运行工作进程的用户账户）。
        * **身份验证/授权设置：** 如启用 Windows 身份验证、匿名身份验证等。
        * **其他 IIS 模块设置：** 如 URL 重写规则、默认文档、MIME 类型等（通常在 `web.config` 中配置）。

3. **部署模式：**
    * **文件系统部署：**
        * **原理：** VS 直接将所有必要的文件复制到目标服务器上的一个指定文件夹（如 `C:\inetpub\wwwroot\MyApp`）。
        * **配置：** 在 IIS 管理器中手动或通过 VS 部署向导创建一个指向该文件夹的 IIS 站点/应用程序，并关联到正确的应用程序池。
        * **优点：** 简单直接，适用于本地部署或拥有文件共享访问权限的远程服务器。
        * **缺点：** 需要手动配置 IIS 部分；远程部署通常需要 SMB 文件共享权限。
    * **Web Deploy (MSDeploy)：**
        * **原理：** VS 使用 Web Deploy 协议与目标服务器上的 Web Deploy 服务通信。它不仅复制文件，还能同步 IIS 配置（站点、应用程序池设置）、数据库、注册表项、ACL 等。
        * **过程：**
            1. VS 根据发布配置文件中的设置连接到目标服务器。
            2. VS 分析应用程序，生成一个部署清单。
            3. VS 将清单和差异化的文件/配置发送给目标服务器的 Web Deploy 服务。
            4. Web Deploy 服务接收请求，应用更改（添加/更新/删除文件，配置 IIS）。
        * **优点：** 强大、自动化程度高，支持增量部署（只传输更改的部分）、配置转换、数据库部署等。是部署到远程 IIS 的标准方法。
        * **缺点：** 需要在目标服务器上安装和配置 Web Deploy 服务；需要防火墙开放端口（默认 8172）。

4. **应用程序启动与请求处理：**
    * **ASP.NET Framework：**
        * IIS 工作进程 (`w3wp.exe`) 加载 .NET CLR（由应用程序池的 CLR 版本指定）。
        * CLR 加载你的应用程序集。
        * `aspnet_isapi.dll` (在经典模式下) 或集成管道模块将 HTTP 请求路由到 ASP.NET 运行时。
        * ASP.NET 运行时（`System.Web`）处理请求，执行页面生命周期或 MVC 控制器/动作。
    * **ASP.NET Core：**
        * IIS 工作进程 (`w3wp.exe`) 启动。
        * **ASP.NET Core 模块：** 这是一个本机 IIS 模块 (`AspNetCoreModuleV2.dll`)，由 `web.config` 指定。它是处理请求的关键桥梁。
        * **启动进程外：** ANCM 的主要角色是作为**反向代理**启动你的 ASP.NET Core 应用程序（一个独立的 `.exe` 或 `dotnet.exe` 进程）。
        * **Kestrel：** 你的 ASP.NET Core 应用程序在其自己的进程中运行，默认使用内置的 Kestrel Web 服务器监听一个端口（通常不是 80/443，是 ANCM 动态分配的）。
        * **请求流程：**
            1. 客户端请求到达 IIS。
            2. ANCM 拦截请求（基于配置的处理器映射）。
            3. ANCM 如果尚未启动你的应用进程，则启动它（`dotnet yourapp.dll`）。
            4. ANCM 将请求转发到你的应用进程（Kestrel）监听的端口。
            5. Kestrel 接收请求，进入 ASP.NET Core 中间件管道处理。
            6. 应用生成响应。
            7. 响应通过 Kestrel 返回给 ANCM。
            8. ANCM 将响应传递回 IIS。
            9. IIS 将响应发送给客户端。

5. **Visual Studio 中的调试部署：**
    * 当你在 VS 中选择 IIS Express 或本地 IIS 并按 F5 调试时：
        * **IIS Express：**
            * 轻量级、自包含的开发服务器，模拟完整 IIS 的核心功能。
            * VS 启动 `iisexpress.exe` 进程。
            * 进程加载你的应用程序集。
            * VS 自动将调试器附加到 `iisexpress.exe` 进程（包含你的应用代码）。
        * **本地完整 IIS：**
            * VS 确保应用程序已部署（文件复制）到配置的 IIS 物理路径。
            * VS 向 IIS 发送命令启动关联的应用程序池（如果未运行）。
            * VS 将调试器附加到承载你应用程序的 `w3wp.exe` 工作进程。
        * 在这两种情况下，VS 还会启动一个浏览器实例，导航到应用程序的根 URL（例如 `http://localhost:port`）。

**总结关键点：**

1. **核心任务：** 复制文件 + 配置 IIS（站点路径、应用程序池）。
2. **IIS 角色：** 主机、反向代理（尤其对 Core）、进程管理（应用程序池）。
3. **部署方式：**
    * **文件系统：** 简单文件复制，IIS 配置手动/向导完成。
    * **Web Deploy：** 强大的协议，自动化文件同步和 IIS 配置同步（远程部署首选）。
4. **运行差异：**
    * **ASP.NET Framework：** 直接运行在 IIS 工作进程内。
    * **ASP.NET Core：** 由 ANCM 模块启动的独立进程外运行（Kestrel），IIS/ANCM 作为反向代理。
5. **调试：** VS 处理部署、启动服务器（IIS Express/IIS）、附加调试器到工作进程、启动浏览器。

理解这些原理有助于你更好地配置部署设置、诊断部署失败问题以及优化应用程序在 IIS 上的运行性能。
