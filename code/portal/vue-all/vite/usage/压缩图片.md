# 压缩图片

- [压缩图片](#压缩图片)
  - [使用 vite-plugin-image-optimizer](#使用-vite-plugin-image-optimizer)
    - [安装](#安装)
    - [配置 vite.config.js](#配置-viteconfigjs)
    - [按需压缩配置](#按需压缩配置)
  - [图片格式选择策略](#图片格式选择策略)
  - [总结](#总结)

原主流插件 `vite-plugin-imagemin` 已不兼容 Vite5，下面介绍使用 `vite-plugin-image-optimizer` 压缩图片

## 使用 vite-plugin-image-optimizer

这是最常用的图片压缩插件，支持多种图片格式。

### 安装

```bash
npm install vite-plugin-image-optimizer -D
npm install sharp -D
```

### 配置 vite.config.js

```javascript
import { defineConfig } from 'vite'
import { ViteImageOptimizer } from "vite-plugin-image-optimizer";

export default defineConfig({
  plugins: [
    ViteImageOptimizer({
      png: {
        quality: 80, // 质量（0-100，值越高越清晰，体积越大）
      },
      jpeg: { quality: 80 },
      webp: {
        quality: 80,
        lossless: false,
      },
      avif: { quality: 75 }, // AVIF 压缩率比 WebP 更高，但兼容性稍弱
      include: /\.(png|jpe?g|svg)$/i, // 仅处理指定格式
      exclude: /node_modules/, // 排除 node_modules 目录
    }),
  ],
})
```

build 完后会输出图片压缩的结果到控制台，例子可查看 [github 地址](https://github.com/FatehAK/vite-plugin-image-optimizer)

### 按需压缩配置

如果你只想在生产环境压缩图片：

```javascript
import { defineConfig } from 'vite'
import { ViteImageOptimizer } from "vite-plugin-image-optimizer";

export default defineConfig(({ mode }) => ({
  plugins: [
    mode === 'production' && ViteImageOptimizer(...),
  ].filter(Boolean),
}))
```

## 图片格式选择策略

```javascript
// 在代码中根据需求选择格式
const imageSrc = isProduction 
  ? '@/assets/image.webp'  // 生产环境用 WebP
  : '@/assets/image.jpg'   // 开发环境用原图
```

## 总结

1. **开发阶段**：使用在线工具手动压缩大图
2. **构建阶段**：使用 `vite-plugin-image-optimizer` 自动压缩
3. **格式选择**：优先使用 WebP，兼容性考虑提供回退方案
4. **按需加载**：大图片考虑使用懒加载

这样配置后，运行 `npm run build` 时 Vite 会自动压缩项目中的图片资源。
