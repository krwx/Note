# 实现功能

- [实现功能](#实现功能)
  - [表格高效删除不连续多行](#表格高效删除不连续多行)
  - [删除数据行的空白行](#删除数据行的空白行)
    - [1. 用Excel自带的函数进行删除](#1-用excel自带的函数进行删除)
    - [2. 用循环的方法逐行删除](#2-用循环的方法逐行删除)
  - [导入模块](#导入模块)
  - [打开浏览器并访问 url](#打开浏览器并访问-url)
  - [往数组插入元素](#往数组插入元素)
  - [判断数组中的每个值是否在字符串中](#判断数组中的每个值是否在字符串中)
  - [复制可见单元格（跳过隐藏行）到新工作表](#复制可见单元格跳过隐藏行到新工作表)

## 表格高效删除不连续多行

- 在一个拥有几万条数据的Excel中，若要删除其中其些行数据，并且这些行是不连续的。如果用 for 循环遍历、判断后一条一条的删除的效率是很低的。那么有什么方法可以在1秒级别的时间里删除这些行呢？

- 大致思路是先将这些行连续起来，再批量删除。

- 可以借用一列数据进行辅助。for循环判断出将要删除的行，在辅助列的位置设置一个标志位，如“1”。再将这列排序，最后删除。代码如下：

```vb
Dim rowBegin As Integer
Dim rowMax As Integer
rowBegin = 2
rowMax = ActiveSheet.UsedRange.Rows.count

'省略设置标志位的代码
'借用Z列辅助

'排序
Range("A" & rowBegin & ":Z" & rowMax).Sort key1:=Range("Z" & rowBegin), order1:=xlAscending, header:=xlNo
'删除
If [Z65536].End(xlUp).row >= rowBegin Then
    Rows(rowBegin & ":" & [Z65536].End(xlUp).row).Delete
End If
```

## 删除数据行的空白行

### 1. 用Excel自带的函数进行删除

```vb
' 取 A 列，然后用 SpecialCells 获取空白的单元格，使用 EntireRow.Delete	删除单元格对应行
sub Del_rows()	
    Sheets("Data").Columns("A").SpecialCells(xlCellTypeBlanks).EntireRow.Delete	
end sub

' 不能用 UsedRange 然后再删除，因为可能有重叠的区域，不能删除重叠的区域
```

缺点：不够灵活，如果某行部分单元格为空，该方法不适用。

### 2. 用循环的方法逐行删除

```vb
sub Del_rows()	
    Imax = Sheets("Data").range("A100000").end(xlup).Row
    For m = 1 To Imax
        If Sheets("Data").Cells(m , 1) = "" Then
            Rows(m).Delete
            m = m - 1
        End If
    Next m
end sub    
```

```vb
Sub RemoveBlankRows()
    Dim rng As Range
    Dim lastRow As Long
    Dim i As Long
    
    ' 设置工作表
    With ThisWorkbook.Sheets("Sheet1")
        ' 找到最后一行
        lastRow = .Cells(.Rows.Count, "A").End(xlUp).Row
        
        ' 从下往上遍历行
        For i = lastRow To 1 Step -1
            ' 如果当前行是空的
            If Application.WorksheetFunction.CountA(.Rows(i)) = 0 Then
                ' 删除当前行
                .Rows(i).Delete
            End If
        Next i
    End With
End Sub
```

## 导入模块

参数中的路径都为绝对路径

获取模块

```vb
ThisWorkbook.VBProject.VBComponents("CommonUtil")

' 获取模块的名称
ThisWorkbook.VBProject.VBComponents("CommonUtil").Name
```

导入模块

```vb
ThisWorkbook.application.VBE.ActiveVBProject.VBComponents.Import [FilePath]
```

移除模块

```vb
ThisWorkbook.VBProject.VBComponents.Remove ThisWorkbook.VBProject.VBComponents("CommonUtil")
```

## 打开浏览器并访问 url

语法：`CreateObject("WScript.Shell").Run """" & URL & """", 1, False`

使用默认浏览器打开

解析：

- `CreateObject("WScript.Shell")`
  - 创建 Windows Script Host 的 Shell 对象（WScript.Shell）
  - 提供访问 Windows Shell 功能的能力（执行程序、操作注册表等）
- `.Run(Command, WindowStyle, WaitOnReturn)`
  - Command：被执行的命令/URL
  - WindowStyle：窗口显示模式
    - 0-隐藏, 1-正常, 2-最小化, 3-最大化
  - WaitOnReturn：是否等待执行完成
    - True 会阻塞 VBA 直到浏览器关闭
- `"""" & URL & """"`
  - 实际效果：`"https://example.com"`
  - `""""` 表示 `""` 的字符串
  - 意思：URL 前后拼接一个表示 `""` 的字符串

例子：

```vb
Sub OpenUrl
    On Error GoTo ErrorHandler
    Dim URL As String
    URL = "https://denotms624.corp.int.kn/QCLocations"
    
    Dim TempShell
    Set TempShell = CreateObject("WScript.Shell")
    TempShell.Run """" & URL & """", 1, False
    Exit Sub
ErrorHandler:
    MsgBox "Open browser fail:" & Err.Description, vbCritical
    Exit Sub
End Sub
```

## 往数组插入元素

```vb
Function InsertElementInArray(ByRef arr() As Variant, ByVal index As Integer, ByVal newElement As Variant)
    Dim i As Integer
    Dim temp() As Variant
    
    ReDim temp(LBound(arr) To UBound(arr) + 1)
    For i = LBound(arr) To index - 1
        temp(i) = arr(i)
    Next i
    temp(index) = newElement
    For i = index To UBound(arr)
        temp(i + 1) = arr(i)
    Next i
    
    InsertElementInArray = temp
End Function
```

## 判断数组中的每个值是否在字符串中

```vb
Function AllValuesInString(arr, str) As Boolean
    Dim i As Integer
    Dim allIn As Boolean
    allIn = True
    
    For i = LBound(arr) To UBound(arr)
        If InStr(1, str, arr(i)) = 0 Then
            allIn = False
            Exit For
        End If
    Next i
    
    AllValuesInString = allIn
End Function
```

## 复制可见单元格（跳过隐藏行）到新工作表

复制当前工作表 A1:C10 区域的可见单元格（跳过隐藏行）到新工作表

```vb
Sub CopyVisibleCellsToNewSheet()
    Dim srcSheet As Worksheet
    Dim newSheet As Worksheet
    Dim visibleRng As Range
    
    ' 设置源工作表为当前活动工作表
    Set srcSheet = ActiveSheet
    
    ' 检查A1:C10区域是否有可见单元格
    On Error Resume Next
    Set visibleRng = srcSheet.Range("A1:C10").SpecialCells(xlCellTypeVisible)
    On Error GoTo 0
    
    ' 如果没有可见单元格则退出
    If visibleRng Is Nothing Then
        MsgBox "没有可见单元格可复制", vbExclamation
        Exit Sub
    End If
    
    ' 添加新工作表
    Set newSheet = Worksheets.Add(After:=srcSheet)
    newSheet.Name = "CopiedData_" & Format(Now, "hhmmss")
    
    ' 复制可见区域到新工作表
    visibleRng.Copy Destination:=newSheet.Range("A1")
End Sub
```
