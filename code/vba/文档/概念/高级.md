# 高级

- [高级](#高级)
  - [设置属性时执行代码](#设置属性时执行代码)
  - [了解参数数组](#了解参数数组)
  - [将数据写入文件](#将数据写入文件)
    - [Open 语句](#open-语句)
  - [正则表达式](#正则表达式)
    - [SubMatches](#submatches)

## 设置属性时执行代码

> 类似于 `js` 中变量的 `set` 和 `get` 语法

可以创建具有相同名称的 `Property Let`、 `Property Set` 和 `Property Get` 过程。 通过执行此操作，您可以创建一组相关共同协作的过程。

`Property Let`语句**可让您创建设置属性的值的过程**。

```vb
Private IsInverted As Boolean 

' 创建设置属性的值的过程 
Property Let Inverted(X As Boolean) 
 IsInverted = X 
 If IsInverted Then 
 … 
 (statements) 
 Else 
 (statements) 
 End If 
End Property
```

此属性获取过程用于返回属性的当前状态。

```vb
Property Get Inverted() As Boolean 
 Inverted = IsInverted 
End Property
```

语句说明：

- Property Let：一个设置属性值的过程。
- Property Get：一个返回属性值的过程。
- Property Set：一个设置对对象的引用的过程。

## 了解参数数组

参数数组可用于**将一组参数传递给过程**。

使用 `ParamArray` 关键字可表示参数数组。

**该数组必须声明为类型为 `Variant` 的数组，并且它必须是过程定义中的最后一个参数。**

```VB
Sub AnyNumberArgs(strName As String, ParamArray intScores() As Variant) 
 Dim intI As Integer 
 
 Debug.Print strName; " Scores" 
 ' Use UBound function to determine upper limit of array. 
 For intI = 0 To UBound(intScores()) 
 Debug.Print " "; intScores(intI) 
 Next intI 
End Sub
```

下面的示例演示如何调用此过程。

```VB
AnyNumberArgs "Jamie", 10, 26, 32, 15, 22, 24, 16 
 
AnyNumberArgs "Kelly", "High", "Low", "Average", "High" 
```

## 将数据写入文件

`Open` 语句允许你直接创建和访问文件。 `Open` 提供三种类型的文件访问：

- **顺序访问**
  - `Append、Input、Output` 模式
  - 用于写入文本文件，如错误日志和报告。
  - output 模式会覆盖文件原来的内容
  - append 模式会在文件原来的内容的基础上添加内容
- **随机访问**
  - `Random` 模式
  - 用于从文件中读取数据和向文件中写入数据，但不关闭文件。 随机访问文件将数据保留在记录中，从而便于快速查找信息。
- **二进制访问**
  - `Binary` 模式
  - 用于读取或写入到文件中的任何字节位置，如存储或显示位图图像。

|访问类型|写入数据|读取数据|
|--|--|--|
|顺序|`Print #`、`Write #`|`Input #`|
|随机|`Put`|获取|
|`Binary`|`Put`|`Get`|

例子：

```vb
Dim FileName
FileName = "C:\Users\kevin.chen\OneDrive - Kuehne+Nagel\Documents\Project\vbaTest\TEST.txt"' Create file name.
Open FileName For Output As #1 ' Open file.
Print #1, "This is a test." ' Write string to file.
Close ' Close open file.
```

### Open 语句

启用对文件的输入/输出 (I/O)。

语法：

`Open pathname For mode [ Access access ] [ lock ] As [ # ] filenumber [ Len = reclength ]`

|Part|说明|
|--|--|
|pathname|必填。 指定文件名的字符串表达式，可包括目录或文件夹和驱动器。|
|mode|必填。 指定文件模式的关键字：Append、Binary、Input、Output 或 Random。 如果未指定，则以 Random 访问模式打开文件。|
|访问|可选。 指定可对打开的文件执行的操作的关键字：Read、Write 或 Read Write。|
|锁|可选。 关键字指定由其他进程对打开的文件限制的操作： 共享、 锁定读取、 锁定写入和 锁定读写。|
|filenumber|必填。 一个有效文件号，范围为 1 到 511（含 1 和 511）。 使用 FreeFile 函数获取下一个可用文件编号。|
|reclength|可选。 小于或等于 32,767（字节）的数。 对于以随机访问模式打开的文件，此值为记录长度。 对于序列文件，此值为缓冲的字符数。|

- 只有打开文件后才能对其执行任何 I/O 操作。 Open 分配一个缓冲区以对文件执行 I/O 操作，同时确定用于此缓冲区的访问模式。
- 如果 `pathname` 指定的文件不存在，那么在以 `Append、Binary、Output 或 Random` 模式打开文件时，即会创建它。
- 如果文件已由另一个进程打开，并且不允许指定的访问类型， 则 Open 操作将失败并发生错误。
- 在 二进制、 输入和 随机 模式下，可以使用其他文件编号打开文件，而无需先关闭文件。 在 `Append` 和 `Output` 模式中，必须先关闭该文件，然后才能用不同文件号打开它。

## 正则表达式

需要先选 `Microsoft VBScript Regular Expressions 5.5` 引用

参数：

- 必需参数
  - Pattern ：搜索模式，传递正则表达式
  - 需要搜索的字符串
- 可选参数
  - `Global`
    - 布尔型
    - 如果设置为 `True` ，返回所有的匹配。如果设置为 `False` ，仅返回第一个匹配。
    - 默认值为 `False` 。
  - `IgnoreCase`
    - 布尔型。
    - 如果设置为 `True` ，匹配模式不区分大小写。
    - 默认值为 `False` ，即区分大小写。
  - `MultiLine`
    - 布尔型。
    - 如果设置为 `True` ，则会改变搜索模式中^（“字符串开头”）和$（“字符串结尾”）元字符的解析，以便它们匹配行的开头和结尾。
    - 默认值为 `False` 。

方法：

- `Replace` 方法：用于替换匹配到的字符串。
- `Execute` 方法：用于在字符串中查找匹配的模式。
- `Test` 方法：用于测试字符串是否匹配模式。

`Replace` 方法

```vb
Sub ExampleRegex()  
    Dim regEx As Object  
    Dim strInput As String  
    Dim strPattern As String  
    Dim strReplace As String  
      
    ' 创建一个正则表达式对象  
    Set regEx = CreateObject("VBScript.RegExp")  
      
    ' 设置模式和属性  
    regEx.Pattern = "\d+" '匹配一个或多个数字  
    regEx.Global = True '全局匹配  
    regEx.IgnoreCase = True '不区分大小写  
      
    ' 输入字符串  
    strInput = "This is a sample string 123456"  
    ' 设置替换字符串  
    strReplace = "****"  
      
    ' 执行替换操作  
    strInput = regEx.Replace(strInput, strReplace)  

    ' 输出结果  
    MsgBox strInput  
End Sub
```

`Execute` 方法 :

```vb
Sub CallRegEx()
    Dim strInput As String
    Dim strPattern As String
    strInput = "在这个字符串中包含邮件地址,'Mary-Jo.T.Williamson_01+test@test-site.com'."
    strPattern ="[a-z0-9-.+_]+@[a-z-]+\.[a-z]+"

    Dim results As MatchCollection
    Dim result As Match
    Dim regEx As New RegExp
    regEx.Global = True
    regEx.IgnoreCase = True
    regEx.Pattern = strPattern
    Set results = regEx.Execute(strInput)

    If Not results Is Nothing Then
        For Each r In results
            Debug.Print r
        Next r
    End If
End Sub
```

`Test` 方法

```vb
Sub ExampleRegex()  
    Dim regEx As Object  
    Dim strInput As String  
    Dim strPattern As String  
    Dim strReplace As String  
      
    ' 创建一个正则表达式对象  
    Set regEx = CreateObject("VBScript.RegExp")  
      
    ' 设置模式和属性  
    regEx.Pattern = "\d+" '匹配一个或多个数字  
    regEx.Global = True '全局匹配  
    regEx.IgnoreCase = True '不区分大小写  
      
    ' 输入字符串  
    strInput = "This is a sample string 123456"  

    If regEx.Test(strInput) Then
      MsgBox strInput  
    End If
End Sub
```

> vba 正则表达式识别不了【?=】和【?!】

### SubMatches

`SubMatches()` 是用于捕获分组匹配内容的关键属性，需配合 `()` 分组和 `Execute` 方法使用。

核心概念：

- `SubMatches` 属性
  - 属于 `Match` 对象，返回一个字符串集合（**索引从 0 开始**），对应正则表达式中 (分组) 捕获的内容。
  - `SubMatches(0)` 代表第一个 (分组)
  - 如果正则中没有 `()`，`SubMatches` 会返回空集合。
  - 用 `(?: )` 表示不捕获的分组，不会出现在 `SubMatches` 中
    - `pattern = "(\d{4})-(?:\d{2})-(\d{2})"` 只捕获年和日
- 使用步骤：
  - 用 `( )` 在正则模式中定义捕获分组
  - 用 `Execute` 执行匹配
  - 遍历 `Matches` 集合 → 访问每个 `Match` 的 `.SubMatches(索引)`

示例代码：

提取日期中的年月日

```vb
Sub ExtractDateParts()
    Dim regEx As Object, matches As Object, match As Object
    Dim inputText As String, pattern As String
    
    ' 创建正则对象
    Set regEx = CreateObject("VBScript.RegExp")
    inputText = "日期: 2023-05-15, 另一日期: 2024-12-31"
    
    ' 设置正则参数
    pattern = "(\d{4})-(\d{2})-(\d{2})"  ' 3个捕获分组：年、月、日
    With regEx
        .Global = True    ' 查找所有匹配
        .IgnoreCase = True ' 忽略大小写
        .Pattern = pattern
    End With
    
    ' 执行匹配
    Set matches = regEx.Execute(inputText)
    
    ' 遍历匹配结果
    For Each match In matches
        ' 整个匹配值 (e.g. "2023-05-15")
        Debug.Print "完整日期: " & match.Value
        
        ' 通过SubMatches访问分组
        Debug.Print "年份: " & match.SubMatches(0)  ' 第一个分组 → (\d{4})
        Debug.Print "月份: " & match.SubMatches(1)  ' 第二个分组 → (\d{2})
        Debug.Print "日期: " & match.SubMatches(2)  ' 第三个分组 → (\d{2})
        Debug.Print "-----"
    Next match
End Sub
```

输出：

```text
完整日期: 2023-05-15
年份: 2023
月份: 05
日期: 15
-----
完整日期: 2024-12-31
年份: 2024
月份: 12
日期: 31
-----
```
