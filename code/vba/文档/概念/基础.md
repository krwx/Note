# 基础

- [基础](#基础)
  - [声明常量](#声明常量)
  - [声明变量](#声明变量)
  - [创建对象变量](#创建对象变量)
    - [声明对象变量](#声明对象变量)
    - [将对象变量分配给对象](#将对象变量分配给对象)
    - [模块级对象变量](#模块级对象变量)
    - [ByRef, ByVal](#byref-byval)
  - [声明数组](#声明数组)
    - [声明固定数组](#声明固定数组)
    - [声明动态数组](#声明动态数组)
  - [使用数组](#使用数组)
    - [更改下限](#更改下限)
    - [在数组中存储 Variant 值](#在数组中存储-variant-值)
    - [使用多维数组](#使用多维数组)
    - [添加元素到数组中](#添加元素到数组中)
    - [数组判空](#数组判空)
    - [获取数组的长度](#获取数组的长度)
  - [了解命名参数和可选参数](#了解命名参数和可选参数)
  - [使用 Do...循环语句](#使用-do循环语句)
    - [条件为 True 时重复语句](#条件为-true-时重复语句)
    - [重复语句，直到条件变为 True](#重复语句直到条件变为-true)
    - [正在退出 Do...循环内部的循环语句](#正在退出-do循环内部的循环语句)
    - [使用 For Each...Next 语句](#使用-for-eachnext-语句)
    - [循环读取一系列单元格](#循环读取一系列单元格)
    - [在 For Each...Next 循环完成前退出该循环](#在-for-eachnext-循环完成前退出该循环)
    - [使用 For...Next 语句](#使用-fornext-语句)
      - [更改计算器变量](#更改计算器变量)
    - [跳过当前循环](#跳过当前循环)
  - [使用 If...Then...Else 语句](#使用-ifthenelse-语句)
    - [如果条件为 True，则运行语句](#如果条件为-true则运行语句)
    - [如果条件为 True，则运行特定语句；如果条件为 False，则运行其他语句](#如果条件为-true则运行特定语句如果条件为-false则运行其他语句)
    - [如果第一个条件为 False，则测试第二个条件](#如果第一个条件为-false则测试第二个条件)
  - [使用 Select Case 语句](#使用-select-case-语句)
  - [使用 With 语句](#使用-with-语句)
  - [编写 Sub 过程](#编写-sub-过程)
    - [参数](#参数)
  - [编写函数过程](#编写函数过程)

## 声明常量

以下示例将 公共 常量 conAge 声明为 Integer ，并为其赋值 34。

```VB
Public Const conAge As Integer = 34
```

常量可以声明为以下 数据类型之一： 布尔、 字节、 整数、 长、 货币、 单、 双、 日期、 字符串或 Variant。

可在一个语句中声明多个常量。 若要指定数据类型，必须为每个常量包括数据类型。

```VB
Const conAge As Integer = 34, conWage As Currency = 35000
```

## 声明变量

声明变量时，通常使用 Dim 语句。

变量可以声明为以下数据类型之一：`Boolean、Byte、Integer、Long、Currency、Single、Double、Date、String`（适用于可变长度的字符串）、`String * length`（适用于固定长度的字符串）、`Object` 或 `Variant`。

如果不指定数据类型，则默认分配 `Variant` 数据类型。

```vb
Dim strName As String

Dim intX As Integer, intY As Integer, intZ As Integer 

Dim intX, intY, intZ As Integer
```

在上面的语句中将 x 和 y 声明为整数的缩写是：

```VB
Dim intX%, intY%, intZ as Integer
```

该类型的缩写是：`% -integer; & -long; @ -currency; # -double; ! -single; $ -string`

- 使用 Public 语句声明公共模块级变量。
- 使用 Private 语句声明私有模块级变量。

**注意**：

- 声明了数字类型的变量，就算没有给它赋值，也会有个默认的初始值：0

## 创建对象变量

### 声明对象变量

使用 `Dim` 语句或其他声明语句之一 (`Public、 Private 或 Static`) 来声明对象变量。 引用对象的 变量 必须是 `Variant`、 `Object` 或特定类型的对象。

```VB
' Declare MyObject as Variant data type. 
Dim MyObject 
' Declare MyObject as Object data type. 
Dim MyObject As Object 
' Declare MyObject as Font type. 
Dim MyObject As Font 
```

> 如果使用对象变量而不事先声明它，则对象变量的数据类型默认为 `Variant` 。
> 定义的对象变量没有范围的说法，都是全局的

声明特定对象类型可实现自动类型检查、加快编码速度和提高可靠性。

```vb
Dim MyObject As Sample ' Declared only as Sample object. 
```

### 将对象变量分配给对象

使用 `Set` 语句将对象分配给对象变量。 可以分配 对象表达式 或 `Nothing`。 例如，以下对象变量赋值有效。

```VB
Set MyObject = YourObject ' Assign object reference. 
Set MyObject = Nothing ' Discontinue association. 
```

您可以通过将 `New` 关键字与 `Set` 语句一起使用来将声明对象变量与向对象变量分配对象结合。 例如：

```VB
Set MyObject = New Object ' Create and Assign 
```

将对象变量设置为等于 `Nothing` 将中断对象变量与任何特定对象的关联。 这将防止因意外更改变量而更改对象。 关闭关联的对象后，对象变量始终设置为 `Nothing` ，以便可以测试对象变量是否指向有效的对象。 例如：

```VB
If Not MyObject Is Nothing Then 
 ' Variable refers to valid object. 
 . . . 
End If
```

### 模块级对象变量

注意：

- 在程序运行的过程中，模块级对象变量指向的值是不会自动清除的。即运行一次 sub 后，再运行这个 sub，模块级对象变量不会自动清空。只有 `Reset` 了程序才会清空

### ByRef, ByVal

- ByRef
  - 传递引用
  - 传递对象时默认使用 ByRef
- ByVal
  - 传递值
  - 传递基础数据类型的数据，使用这个。也可以使用 ByRef 传递引用

传递对象时，使用 ByRef 或 ByVal ，结果都一样

## 声明数组

数组的声明方式与其他变量相同，即，使用 Dim、Static、Private 或 Public 语句声明。

数组是以 0 还是以 1 开始编制索引取决于 `Option Base` 语句的设置。 如果 `Option Base 1` 未指定，则所有数组索引都从零开始。

注意：

- **如果要声明数组变量，则必须包含括号。 下标是可选的。**
- **对象类型的数组，设置值要用 `Set`**

### 声明固定数组

在下面的代码行中，一个固定大小的数组声明为具有 11 行和 11 列的 Integer 数组：

```VB
Dim MyArray(10, 10) As Integer 
```

**第一个参数代表行；第二个参数代表列。**

除非为数组指定数据类型，否则和其他任何变量声明一样，声明数组中元素的数据类型为 `Variant` 。

数组的每个数字 Variant 元素使用 16 位元组。 每个字符串 Variant 元素使用 22 位元组。 要编写尽可能紧凑的代码，请显式声明数组为某个数据类型，而非 Variant 。

下面的代码行比较多个数组的大小。

```VB
' Integer array uses 22 bytes (11 elements * 2 bytes). 
ReDim MyIntegerArray(10) As Integer 
 
' Double-precision array uses 88 bytes (11 elements * 8 bytes). 
ReDim MyDoubleArray(10) As Double 
 
' Variant array uses at least 176 bytes (11 elements * 16 bytes). 
ReDim MyVariantArray(10) 
 
' Integer array uses 100 * 100 * 2 bytes (20,000 bytes). 
ReDim MyIntegerArray (99, 99) As Integer 
 
' Double-precision array uses 100 * 100 * 8 bytes (80,000 bytes). 
ReDim MyDoubleArray (99, 99) As Double 
 
' Variant array uses at least 160,000 bytes (100 * 100 * 16 bytes). 
ReDim MyVariantArray(99, 99) 
```

### 声明动态数组

通过声明动态数据，可以在运行代码时调整数组的大小。

使用 Static 、 Dim 、 Private 或 Public 语句声明一个数组，**将括号内留空**，如下面的示例所示。

```VB
Dim sngArray() As Single 
```

`ReDim`:

- 在数组范围内的过程中，使用 `ReDim` 语句可更改维度数、定义元素数，以及定义每个维度的上限和下限。
- 根据需要使用 `ReDim` 语句更改动态数组。 但是，每次这么做时，数组中的现有值都会丢失。
- 使用 `ReDim Preserve` 可在保留数组中现有值的情况下扩展数组。

例如，下面的语句将数组扩增了 10 个元素，而未丢失原始元素的当前值。

```VB
ReDim Preserve varArray(UBound(varArray) + 10) 
```

在对动态数组使用 `Preserve` 关键字时，仅能更改最后一个维度的上限（数量的上限），而不能更改维度数。

## 使用数组

默认情况下，数组的索引从零开始。假设要创建具有 10 个元素的数组，那么上限为 9，即：

```vb
Dim myArray(9) as Integer
```

设置值

```vb
myArray(8) = 10
```

> 默认情况下，**数组是通过引用传递的**。这意味着，如果在函数内部修改了数组中的元素，这些修改会反映到原始数组上。

### 更改下限

使用模块顶部的 `Option Base` 语句将第一个元素的默认索引从 0 更改为 1。 在以下示例中， `Option Base` 语句更改第一个元素的索引， Dim 语句声明具有 365 个元素的数组变量。

```VB
Option Base 1 
Dim curExpense(365) As Currency 
```

也可以通过使用 `To` 子句明确设置数组的下限，如以下示例所示。

```VB
Dim curExpense(1 To 365) As Currency 
Dim strWeekday(7 To 13) As String 
```

### 在数组中存储 Variant 值

有两种方法可以创建 `Variant` 值数组。 一种是声明 `Variant` 数据类型的数组，如以下示例所示：

```VB
Dim varData(3) As Variant 
varData(0) = "Claudia Bendel" 
varData(1) = "4242 Maple Blvd" 
varData(2) = 38 
varData(3) = Format("06-09-1952", "General Date") 
```

另一种方法是将 `Array` 函数返回的数组分配给 `Variant` 变量，如以下示例所示：

```VB
Dim varData As Variant 
varData = Array("Ron Bendel", "4242 Maple Blvd", 38, _ 
Format("06-09-1952", "General Date")) 
```

### 使用多维数组

在 `Visual Basic` 中，您可以声明最多包含 60 个维度的数组。

例如，以下语句声明了一个二维、5*10 的数组。

```VB
Dim sngMulti(1 To 5, 1 To 10) As Single 
```

如果将数组看作矩阵，则第一个参数表示行，第二个参数表示列。

使用嵌套 的 `For...下一个` 用于处理多维数组的语句。 以下过程使用 `Single` 值填充一个二维度组。

```VB
Sub FillArrayMulti() 
 Dim intI As Integer, intJ As Integer 
 Dim sngMulti(1 To 5, 1 To 10) As Single 
 
 ' Fill array with values. 
 For intI = 1 To 5 
 For intJ = 1 To 10 
 sngMulti(intI, intJ) = intI * intJ 
 Debug.Print sngMulti(intI, intJ) 
 Next intJ 
 Next intI 
End Sub
```

### 添加元素到数组中

- 数组中已有元素，添加的元素的 index 为当前最大可用下标 + 1

```vb
Dim myArray() As String
ReDim Preserve myArray(0 To UBound(myArray) + 1)
myArray(UBound(myArray)) = "Grapes"
```

- 数组中没有元素，添加的元素的 index 为当前最大可用下标

```vb
Public Function SetTableRowData(data)
  Dim CurrentUBound%
  CurrentUBound = UBound(TableRowData)
  ReDim Preserve TableRowData(0 To UBound(TableRowData) + 1)
  Set TableRowData(CurrentUBound) = data
End Function
```

### 数组判空

```vb
' 1
Function IsArrayEmpty(arr As Variant) As Boolean
    IsArrayEmpty = (UBound(arr) = -1)
End Function

' 2
Function IsArrayEmpty(arr As Variant) As Boolean
    IsArrayEmpty = (Len(arr) = 0)
End Function

' 3
Function IsArrayEmpty(arr As Variant) As Boolean
    IsArrayEmpty = IsEmpty(arr)
End Function
```

### 获取数组的长度

通过 `UBound() + 1` 获取

```vb
Sub GetArrayLength(arr() As Variant)
    Dim length As Integer
    length = UBound(arr) + 1
    Debug.Print "数组的长度为：" & length
End Sub
```

## 了解命名参数和可选参数

命名参数的使用:

```vb
Sub PassArgs(strName As String, intAge As Integer, dteBirth As Date) 
 Debug.Print strName, intAge, dteBirth 
End Sub

' 只提供参数
PassArgs "Mary", 29, #2-21-69# 

' 提供命名参数
PassArgs intAge:=29, dteBirth:=#2/21/69#, strName:="Mary" 
```

命名参数由参数名称后跟一个冒号和一个等号 (:=) 然后是参数值组成。

在过程定义中，**可选参数**的前面是 `Optional` 关键字。 您也可以在过程定义中为可选参数指定一个默认值。 例如：

```VB
Sub OptionalArgs(strState As String, Optional strCountry As String = "USA") 
. . . 
End Sub
```

- 当您使用可选参数调用过程时，可以选择是否指定可选参数。
- 如果不指定可选参数，则会使用默认值（如果有）。
- 如果未指定默认值，则参数将为指定类型的任何变量。

## 使用 Do...循环语句

### 条件为 True 时重复语句

```vb
Sub ChkFirstWhile() 
    counter = 0 
    myNum = 20 
    ' 先检查再运行循环
    Do While myNum > 10 
        myNum = myNum - 1 
        counter = counter + 1 
    Loop 
    MsgBox "The loop made " & counter & " repetitions." 
End Sub 
 
Sub ChkLastWhile() 
    counter = 0 
    myNum = 9 
    ' 先运行一次，再进行检查，然后通过检查再继续执行
    Do 
        myNum = myNum - 1 
        counter = counter + 1 
    Loop While myNum > 10 
    MsgBox "The loop made " & counter & " repetitions." 
End Sub
```

### 重复语句，直到条件变为 True

使用 `Until` 关键字检查 `Do...Loop` 语句中的条件。循环在条件仍为 `False` 时继续运行。

```vb
Sub ChkFirstUntil() 
    counter = 0 
    myNum = 20 
    Do Until myNum = 10 
        myNum = myNum - 1 
        counter = counter + 1 
    Loop 
    MsgBox "The loop made " & counter & " repetitions." 
End Sub 
 
Sub ChkLastUntil() 
    counter = 0 
    myNum = 1 
    Do 
        myNum = myNum + 1 
        counter = counter + 1 
    Loop Until myNum = 10 
    MsgBox "The loop made " & counter & " repetitions." 
End Sub
```

### 正在退出 Do...循环内部的循环语句

使用 `Exit Do` 语句退出 `Do...` 循环。

```vb
Sub ExitExample() 
    counter = 0 
    myNum = 9 
    Do Until myNum = 10 
        myNum = myNum - 1 
        counter = counter + 1 
        ' 退出循环
        If myNum < 10 Then Exit Do 
    Loop 
    MsgBox "The loop made " & counter & " repetitions." 
End Sub
```

### 使用 For Each...Next 语句

`For Each...Next` 语句会为集合中的每个 对象并为数组中的每个元素重复语句块。

例如，以下 过程 将 10 添加到 `A10` 范围中每个单元格的值。

```VB
Sub Add10ToAllCellsInRange()
    For Each rng In Range("A1:A10")
        rng.Value = rng.Value + 10
    Next
End Sub
```

注意：**`For Each` 后面的变量的类型一定为 `Variant`**

### 循环读取一系列单元格

使用 `For Each...Next` 循环来循环访问范围中的单元格。 下面的过程将循环访问 `Sheet1` 上的范围 `A1:D10`，并将其绝对值小于 0.01 的任何数字设置为 0（零）。

```VB
Sub RoundToZero() 
 For Each rng in Range("A1:D10") 
 If Abs(rng.Value) < 0.01 Then rng.Value = 0 
 Next 
End Sub
```

### 在 For Each...Next 循环完成前退出该循环

可使用 `Exit For` 语句退出 `For Each...Next` 循环。

下面的示例测试范围 A1:B5 中不包含数字的第一个单元格。 如果找到此类单元格，则显示一条消息并且 `Exit For` 将退出循环。

```VB
Sub TestForNumbers() 
 For Each rng In Range("A1:B5") 
  If IsNumeric(rng.Value) = False Then 
   MsgBox "Cell " & rng.Address & " contains a non-numeric value." 
   ' 退出循环
   Exit For 
  End If 
 Next rng 
End Sub
```

### 使用 For...Next 语句

使用 `For...` 下一个 语句将语句块 重复特定次数 。 “For”循环，使用计算器变量（重复循环一次，其值将增加或减少）。

```vb
Sub Beeps() 
    For x = 1 To 50 
        Beep 
    Next x 
End Sub
```

使用 step 进行变量递增或递减操作

```vb
' 递增
Sub TwosTotal() 
    For j = 2 To 10 Step 2 
        total = total + j 
    Next j 
    MsgBox "The total is " & total 
End Sub

' 递减
Sub NewTotal() 
    For myNum = 16 To 2 Step -2 
        total = total + myNum 
    Next myNum 
    MsgBox "The total is " & total 
End Sub
```

使用 `Exit For` 语句可以退出 `For...` 。

#### 更改计算器变量

更改完之后，会执行递增或递减，即下一次循环的值不是更改的值

```vb
Sub TestFor
    Dim I
    For I = 0 To 20
        Debug.Print I
        If I = 10 Then
            I = 15
        End If
    Next I
End Sub
```

### 跳过当前循环

```vb
Sub SkipCurrentIteration()
    Dim i As Integer
    For i = 1 To 10
        If i Mod 2 = 0 Then ' 如果i是偶数，跳过后面的代码
            GoTo ContinueLoop
        End If
        ' 正常的处理代码
        Debug.Print i
ContinueLoop:
    Next i
End Sub
```

## 使用 If...Then...Else 语句

### 如果条件为 True，则运行语句

```VB
Sub FixDate() 
 myDate = #2/13/95# 
 If myDate < Now Then myDate = Now 
End Sub
```

若要运行一行以上的代码，必须使用多行语法。 此语法包括 `End If` 语句，如下面的示例所示。

```VB
Sub AlertUser(value as Long) 
 If value = 0 Then 
 AlertLabel.ForeColor = "Red" 
 AlertLabel.Font.Bold = True 
 AlertLabel.Font.Italic = True 
 End If 
End Sub
```

### 如果条件为 True，则运行特定语句；如果条件为 False，则运行其他语句

```VB
Sub AlertUser(value as Long) 
 If value = 0 Then 
 AlertLabel.ForeColor = vbRed 
 AlertLabel.Font.Bold = True 
 AlertLabel.Font.Italic = True 
 Else 
 AlertLabel.Forecolor = vbBlack 
 AlertLabel.Font.Bold = False 
 AlertLabel.Font.Italic = False 
 End If 
End Sub
```

### 如果第一个条件为 False，则测试第二个条件

```VB
Function Bonus(performance, salary) 
 If performance = 1 Then 
 Bonus = salary * 0.1 
 ElseIf performance = 2 Then 
 Bonus = salary * 0.09 
 ElseIf performance = 3 Then 
 Bonus = salary * 0.07 
 Else 
 Bonus = 0 
 End If 
End Function
```

## 使用 Select Case 语句

```vb
Function Bonus(performance, salary) 
  Select Case performance 
    Case 1 
      Bonus = salary * 0.1 
    Case 2, 3  ' 多种情况
      Bonus = salary * 0.09 
    Case 4 To 6 
      Bonus = salary * 0.07 
    Case Is > 8 
      Bonus = 100 
    Case Else 
      Bonus = 0 
  End Select 
End Function
```

## 使用 With 语句

`With` 语句允许你为**整个一系列语句**指定**一次对象或用户定义的类型**。

下面的示例在一系列单元格中填入数字 30，应用粗体格式，并将单元格的内部颜色设置为黄色。

```VB
Sub FormatRange() 
 With Worksheets("Sheet1").Range("A1:C10") 
 .Value = 30 
 .Font.Bold = True 
 .Interior.Color = RGB(255, 255, 0) 
 End With 
End Sub
```

您可以嵌套 `With` 语句来实现更高的效率。  
下面的示例将公式插入单元格 A1 中，然后设置字体的格式。

```VB
Sub MyInput() 
 With Workbooks("Book1").Worksheets("Sheet1").Cells(1, 1) 
 .Formula = "=SQRT(50)" 
 With .Font 
 .Name = "Arial" 
 .Bold = True 
 .Size = 8 
 End With 
 End With 
End Sub
```

`With Obj` ，后面如果有 `.XXX`，就是 `Obj.XXX` 的意思

如果有多层 With 嵌套，使用 `.` 是以最近一层的 With 为准，不能使用其他 With 层的方法或属性

## 编写 Sub 过程

`Sub` 过程是一系列 Visual Basic 语句，由 `Sub` 语句和 `End Sub` 语句括起来，这些语句**执行操作但不返回值**。

`Sub` 过程可采用参数，例如通过调用过程传递的常量、变量或表达式。  
如果 `Sub` 过程没有参数，则 `Sub` 语句必须包括一组空括号。

```VB
' Declares a procedure named GetInfo 
' This Sub procedure takes no arguments 
Sub Test() 
  Debug.print "hello"
End Sub
```

### 参数

可选参数的前面是 `Optional` 关键字。 您也可以在过程定义中为可选参数指定一个默认值。

```vb
Sub OptionalArgs(strState As String, Optional strCountry As String = "USA") 
. . . 
End Sub
```

## 编写函数过程

函数过程是一系列由 `Function` 和 `End Function` 语句括起来的 Visual Basic 语句。

函数过程类似于 `Sub` 过程，但**函数也可以返回值**。

`Function` 过程可接受通过调用过程传递给它的参数（如常量、变量或表达式）。 如果 `Function` 过程没有参数，则其 `Function` 语句必须包括一对空括号。

怎么返回参数：**给函数名赋值**。如果是基本数据类型，直接赋值。如果是对象类型，使用 `Set [函数名]`

在以下示例中， `Celsius` 函数通过华氏度计算摄氏度。 在从 `Main` 过程调用该函数时，将一个包含参数值的变量传递到该函数。 计算结果会返回到调用过程并在消息框中显示。

```VB
Sub Main() 
 temp = Application.InputBox(Prompt:= _ 
 "Please enter the temperature in degrees F.", Type:=1) 
 MsgBox "The temperature is " & Celsius(temp) & " degrees C." 
End Sub 
 
Function Celsius(fDegrees) 
 Celsius = (fDegrees - 32) * 5 / 9 
End Function
```

```vb
Function GetWorkbook() 
  Dim wb as WorkBook
  Set wb = Application.Workbooks("RATES_2019.xlsb")
  Set GetWorkbook = wb
End Function
```

注意:

- 如果要返回对象，那么要 `Set [FunctionName] = ...`
