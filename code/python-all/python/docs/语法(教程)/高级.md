# 高级

- [高级](#高级)
  - [!r 和 !s](#r-和-s)
  - [File](#file)
    - [open() 方法](#open-方法)
    - [file 对象](#file-对象)
      - [read()](#read)
      - [seek()](#seek)
      - [write()](#write)
      - [close()](#close)
  - [打包](#打包)
    - [打包工具](#打包工具)
    - [`.spec`文件](#spec文件)
    - [打包方式](#打包方式)
    - [封装项目为包](#封装项目为包)
  - [部署自动化脚本](#部署自动化脚本)
    - [容器化部署（Docker）（试一下）](#容器化部署docker试一下)

## !r 和 !s

- `!s` 相当于 `str(val)`
- `!r` 相当于 `repr(val)`

## File

### open() 方法

Python `open()` 方法用于打开一个文件，并返回文件对象。

在对文件进行处理过程都需要使用到这个函数，如果该文件无法被打开，会抛出 `OSError`。

注意：使用 `open()` 方法一定要保证关闭文件对象，即调用 `close()` 方法。

`open()` 函数常用形式是接收两个参数：文件名(file)和模式(mode)。

常用语法：`open(file, mode='r')`

完整的语法格式为：

`open(file, mode='r', buffering=-1, encoding=None, errors=None, newline=None, closefd=True, opener=None)`

参数说明:

- file: 必需，文件路径（相对或者绝对路径）。
- mode: 可选，文件打开模式
- buffering: 设置缓冲
- encoding: 一般使用utf8
- errors: 报错级别
- newline: 区分换行符
- closefd: 传入的file参数类型
- opener: 设置自定义开启器，开启器的返回值必须是一个打开的文件描述符。

注意：

- 最好加上 `encoding="utf-8"` ，因为使用系统默认的 encoding 可能会在读取中文文件时报错

mode 参数：

|模式| 描述|
|--|--|
|r| **以只读方式打开文件**。文件的指针将会放在文件的开头。这是**默认模式（打开文件用于读取文本，与 'rt' 同义）**。|
|t| 文本模式 (默认)。|
|w|写入，并先截断文件|
|x| 写模式，新建一个文件，如果该文件已存在则会报错。|
|a|打开文件用于写入，如果文件存在则在末尾追加|
|b |二进制模式。|
|+ |打开一个文件进行更新(可读可写)。|

```py
with open('example.ini', 'w', encoding="utf-8") as configfile:
  config.write(configfile)
```

### file 对象

file 对象使用 open 函数来创建

#### read()

`read()` 方法用于从文件读取指定的字符数（文本模式 `t`）或字节数（二进制模式 `b`），如果未给定参数 `size` 或 `size` 为负数则读取文件所有内容。

语法：`fileObject.read([size])`

返回值：返回从字符串中读取的字节。**如果要打印出来需要先转换成字符串，通过 `str()`**

注意：

- 调用一次 `read()` 后会返回文件的所有内容，如果再调用一次 `read()` 不会返回任何东西
- 如果给定参数 `size` 读取了部分的文件，再调用 `read()` 会返回文件剩下的内容

文件 `runoob.txt` 的内容如下：

```txt
这是第一行
这是第二行
这是第三行
这是第四行
这是第五行
```

循环读取文件的内容：

```py
# 打开文件
fo = open("runoob.txt", "r+")
print ("文件名为: ", fo.name)

# 读取 10 个字符
line = fo.read(10)
print ("读取的字符串: %s" % (line))

# 关闭文件
fo.close()

"""
输出结果:
文件名为:  runoob.txt
读取的字符串: 这是第一行
这是第二
"""
```

#### seek()

`seek()` 方法用于**移动文件读取指针到指定位置**。

语法如下：`fileObject.seek(offset[, whence])`

参数

- `offset`：开始的偏移量，也就是代表需要移动偏移的字节数，如果是负数表示从倒数第几位开始。
- `whence`：
  - 可选，**默认值为 0**。
  - 给 offset 定义一个参数，**表示要从哪个位置开始偏移**；
  - 0 代表从文件开头开始算起，1 代表从当前位置开始算起，2 代表从文件末尾算起。

返回值：如果操作成功，则返回新的文件位置，如果操作失败，则函数返回 -1。

```py
>>> f = open('workfile', 'rb+')
>>> f.write(b'0123456789abcdef')
16

>>> f.seek(5)      # 移动到文件的第六个字节
5
>>> f.read(1)
b'5'

>>> f.seek(-3, 2)  # 移动到文件倒数第三个字节
13
>>> f.read(1)
b'd'
```

#### write()

`write()` 方法用于向文件中写入指定字符串。

语法：`fileObject.write( [ str ])`

返回值：返回的是写入的字符长度。

注意：调用 `write()` 后文件的读取指针在写入的内容后，如果想调用 `read()` 读取写入的内容，需要先用 `seek()` 改变指针的位置

```py
# 打开文件
fo = open("runoob.txt", "r+")
print ("文件名: ", fo.name)

str = "6:www.runoob.com"
# 在文件末尾写入一行
fo.seek(0, 2)
line = fo.write( str )

# 读取文件所有内容
fo.seek(0,0)
for index in range(6):
    line = next(fo)
    print ("文件行号 %d - %s" % (index, line))

# 关闭文件
fo.close()
```

#### close()

`close()` 方法用于关闭一个已打开的文件。关闭后的文件不能再进行读写操作， 否则会触发 `ValueError` 错误。 `close()` 方法允许调用多次。

## 打包

### 打包工具

常用的Python打包工具主要有以下几种：

- PyInstaller ：可以将 Python 脚本打包成可执行的 exe、app 或 Linux 可执行文件，支持跨平台打包。
- cx_Freeze：可以将 Python 脚本打包成可执行的 exe 文件，支持 Windows、Mac和Linux 等平台。
- py2exe：用于将 Python 脚本打包成 Windows 可执行文件（exe），仅支持 Windows 平台。
- py2app：用于将 Python 脚本打包成 Mac 可执行文件（app bundle），仅支持 Mac 平台。

主要使用 `PyInstaller`

### `.spec`文件

PyInstaller 是一个用于将 Python 程序打包为可执行文件的工具。

该工具的打包原理是将 Python 解释器、脚本代码、依赖库等打包成一个独立的可执行文件，用户无需安装 Python 环境即可运行。

它运行生成的 `.spec` 文件是用来配置打包过程的脚本文件。`.spec` 文件是一个 `Python` 脚本，用于指定 `PyInstaller`

### 打包方式

通过 `.spec` 文件打包：`pyinstaller my_script.spec`

通过 `.py` 文件打包：`pyinstaller --onefile --windowed gui_app.py`

注意：

- 如果打包后的 exe 文件运行不了，可以在 cmd 或者 git bash 直接输入 exe 文件的名称启动 exe 文件，这时可以看到错误信息

### 封装项目为包

## 部署自动化脚本

- 简单定时任务：
  - Crontab(Linux)
  - 任务计划程序(Windows)：通过图形界面设置触发器和操作
- 长期运行服务：Docker + Supervisor
- 事件驱动/无服务器：AWS Lambda
- 跨平台兼容性：虚拟环境 + 容器化

### 容器化部署（Docker）（试一下）

1. 创建 Dockerfile

    ```dockerfile
    FROM python:3.9-slim
    WORKDIR /app
    COPY requirements.txt .
    RUN pip install --no-cache-dir -r requirements.txt
    COPY . .
    CMD ["python", "your_script.py"]
    ```

2. 构建并运行容器

    ```bash
    docker build -t your_script .
    docker run -d --name script_container your_script
    ```

3. 管理容器

    - 查看日志：docker logs script_container
    - 自动重启：docker run --restart always ...
