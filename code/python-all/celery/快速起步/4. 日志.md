# 日志

- [日志](#日志)
  - [在 Celery 配置中设置日志](#在-celery-配置中设置日志)
  - [自定义日志处理器](#自定义日志处理器)
  - [使用 logger](#使用-logger)

## 在 Celery 配置中设置日志

```py
from celery import Celery

app = Celery('myapp')

# 配置日志
app.conf.update(
    worker_log_format='[%(asctime)s: %(levelname)s/%(processName)s] %(message)s',
    worker_task_log_format='[%(asctime)s: %(levelname)s/%(processName)s] [%(task_name)s(%(task_id)s)] %(message)s',
    worker_log_color=True,  # 是否使用颜色
    worker_redirect_stdouts=True,  # 重定向标准输出到日志系统
    worker_redirect_stdouts_level='INFO',  # 重定向的日志级别
)
```

## 自定义日志处理器

使用 `after_setup_logger` 和 `after_setup_task_logger` 信号覆盖 Celery 默认的日志配置，并自定义日志配置

`after_setup_logger` 配置 `worker` 的日志， `after_setup_task_logger` 配置 `task` 的日志

```py
import logging
from celery.signals import after_setup_logger, after_setup_task_logger

@after_setup_logger.connect
def setup_logger(logger, *args, **kwargs):
    # 为 worker 日志添加处理器
    formatter = logging.Formatter('%(asctime)s - %(name)s - %(levelname)s - %(message)s')
    handler = logging.FileHandler('/var/log/celery/worker.log')
    handler.setFormatter(formatter)
    logger.addHandler(handler)

@after_setup_task_logger.connect
def setup_task_logger(logger, *args, **kwargs):
    # 为任务日志添加处理器
    formatter = logging.Formatter('%(asctime)s - %(task_id)s - %(task_name)s - %(levelname)s - %(message)s')
    handler = logging.FileHandler('/var/log/celery/tasks.log')
    handler.setFormatter(formatter)
    logger.addHandler(handler)
```

## 使用 logger

```py
from celery.utils.log import get_task_logger

logger = get_task_logger(__name__)

@app.task
def add(x, y):
    # 打印的为 task 的日志
    logger.info(f"Adding {x} and {y}")
    return x + y
```
