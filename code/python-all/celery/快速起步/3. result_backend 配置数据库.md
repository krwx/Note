# result_backend 配置数据库

- [result\_backend 配置数据库](#result_backend-配置数据库)
  - [配置](#配置)
    - [Mysql](#mysql)
    - [SqlServer](#sqlserver)
  - [初始化数据库表](#初始化数据库表)
    - [展示详细结果](#展示详细结果)
    - [指定表名称](#指定表名称)
  - [other](#other)

## 配置

使用 `result_backend` 配置数据库，填连接数据数据库的字符串，与 `SQL ALchemy` 填的一样

例子：

```py
app = Celery(
    "test",
    broker="amqp://",
    result_backend="db+mysql://user:password@host:port/database_name",
)
```

### Mysql

使用 `mysqlclient` 驱动：

- 安装：`pip install mysqlclient`
- 配置：

    ```py
    app.conf.result_backend = 'db+mysql://user:password@host:port/database_name'
    ```

使用 `pymysql` 驱动：

- 安装：`pip install pymysql`
- 配置：

    ```py
    app.conf.result_backend = 'db+mysql+pymysql://user:password@host:port/database_name'
    ```

### SqlServer

安装驱动：`conda install pyodbc`

配置：

```py
app.conf.result_backend = 'db+mssql+pyodbc://user:password@host:port/database_name'
```

## 初始化数据库表

配置完后启动 Celery，会自动往数据库新增两个表：

- `celery_taskmeta` ：存放单个 task 的结果
- `celery_tasksetmeta` ：存放由 chain 或 group 等等组合起来的 task 的结果

并且会创建两个 `sequence` （在 `Programmability` 的 `Sequences` 可以查看），用于作为新增的表的 id 主键的取值范围：

- `task_id_sequence`
- `taskset_id_sequence`

> 或者通过命令手动创建表：`celery -A your_app inspect db upgrade`  
> 或手动执行 Celery 提供的 SQL 脚本。

**注意**：

`task_id_sequence` 的取值范围为 `-9223372036854775808 ~ 9223372036854775807` ，`Increment by` 为 1。 但是 `celery_taskmeta` 的 `id` 的数据类型为 `int` ，所以超出了 `int` 的取值范围，运行 celery 的时候会报错，所以要将 `id` 的数据类型改为 `bigint`

### 展示详细结果

默认只记录了 `task_id, status, result, date_done, traceback`。

设置 `result_extended` 为 true 才会额外记录 `name, args, kwargs, worker, retries, queue, delivery_info`

```py
app.conf.update(
    result_extended=True,
)
```

### 指定表名称

使用 `database_table_names` 配置数据库表的名称

- `task` ：指定存放单个 task 的结果的表的名称
- `group` ：指定存放多个 task 同时运行的结果的表的名称

例子：

```py
app.conf.update(
    database_table_names={
        "task": "qc_celery_taskmeta",
        "group": "qc_celery_tasksetmeta",
    },
)
```

## other

测试插入表数据的 sql 语句：

```sql
`INSERT INTO celery_taskmeta (id, task_id, status, result, date_done, traceback) OUTPUT inserted.id VALUES (NEXT VALUE FOR task_id_sequence, '5c265cb5-55af-4ce3-8de0-b721d485b57c', 'PENDING', NULL, NULL, NULL)`
```

使用 `NEXT VALUE FOR task_id_sequence` 代表 sequence 的下一个值
