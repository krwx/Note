# 介绍

- [介绍](#介绍)
  - [安装](#安装)
  - [工作流程](#工作流程)
  - [Concurrency](#concurrency)
  - [Backends and Broker](#backends-and-broker)
  - [queue](#queue)

Celery 是一个简单、灵活且可靠的分布式系统，用于处理大量消息

它是一个专注于实时处理的任务队列，同时也支持任务调度。

重要概念：

- task
  - 需要做的任务
- task queue
  - 任务队列
- broker
  - 经纪人，将 task queue 中的 task 分配给 worker
- worker
  - 做 task 的地方
- backends
  - 存储任务结果的地方

## 安装

```sh
conda install celery
# or
pip install celery

# windows 使用 eventlet 或 gevent 模式，需要安装 eventlet 或 gevent
conda install eventlet

# 使用 flower
conda install flower
```

## 工作流程

任务队列被用作在线程或机器之间分配工作的机制。

任务队列的输入是一个称为任务的工作单元。专用 worker 进程会持续监控任务队列以执行新工作。

Celery 通过消息进行通信，通常使用 broker 在 Client 端和 Worker 之间进行调解。要启动任务，客户端会添加消息到队列，然后 Broker 会将该消息传递给 Worker。

Celery 系统可以由多个 worker 和 broker 组成

## Concurrency

并发模式：

- prefork (multiprocessing)
  - 多进程
  - Linux 支持，Windows 不支持
- Eventlet, gevent
  - 使用协程
  - Windows 支持
- thread (multithreaded)
  - 多线程
  - Windows 支持
- solo (single threaded)
  - 单线程，debug 的时候使用

## Backends and Broker

- RabbitMQ
  - RabbitMQ 是 broker
  - **celery 默认使用 RabbitMQ 使用 broker**
  - 作为 broker，RabbitMQ 比 Redis 能更好地处理较大的消息，但是，如果许多消息非常快速地传入，则扩展可能成为一个问题。除非 RabbitMQ 以非常大规模运行，否则应考虑使用 Redis 或 SQS
  - 作为 backend，RabbitMQ 可以通过 `rpc://` 后端存储结果。此后端为每个客户端创建单独的临时队列。
- Redis
  - Redis 既可以是 backend，也可以是 broker。
  - 作为 broker，Redis 非常适合快速传输短消息。大消息可能会使系统拥塞。
  - 作为 backend，Redis 是一种超快的 K/V 存储，因此可以非常有效地获取任务调用的结果。您必须考虑用于存储数据的内存限制，以及如何处理数据持久性。如果结果持久性很重要，请考虑将另一个数据库用于后端。
- SQLAlchemy
  - SQLAlchemy 是一个 backend。
  - 它允许 Celery 与 MySQL、PostgreSQL、SQlite 等交互。它是一个 ORM，也是 Celery 可以使用 SQL 数据库作为结果后端的方式。

> 注意：RabbitMQ（作为 broker ）和 Redis（作为 backends）是非常常见的一起使用。如果结果存储需要更有保证的长期持久性，请考虑使用 PostgreSQL 或 MySQL（通过 SQLAlchemy）自定义后端。

## queue

当运行 Celery 并连接到 RabbitMQ 时，默认情况下可能会生成以下三个队列，它们的作用如下：

- 默认任务队列
  - 通常名为 `celery`
  - 作用：这是 Celery 的主要任务队列。所有未明确指定路由的任务都会发送到该队列，由工作节点（Worker）监听并处理。
  - **默认是持久化的**，即 queue 会永久存在。

- **事件监控**队列
  - 通常以 `celeryev` 或 `.celeryev` 开头
  - 每个 `worker` 一个事件监控队列
  - 作用：用于传输 Celery 的事件消息（如任务状态、Worker 节点心跳等），支持实时监控工具（如 Flower）或 `celery events` 命令。

- **远程控制**队列
  - 通常以 `worker_name` 开头，以 `celery.pidbox` 结尾
  - 作用：用于向 `Worker` 发送管理命令（如终止任务、查看运行状态、动态调整日志级别等）。例如，使用 `celery control` 或 `app.control` 接口时，命令会通过此队列传递。

默认的三个队列是 Celery 核心功能的体现：**任务处理、事件监控和远程控制**。

队列名称例子：

```txt
celery
celeryev.172493ac-c78d-462d-8a66-25127f4107f9
celery@host_name.celery.pidbox
```
