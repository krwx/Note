# 安装

- [安装](#安装)
  - [介绍](#介绍)
  - [安装 Apache](#安装-apache)
  - [安装 microsoft visual c++ 14.0 or greater](#安装-microsoft-visual-c-140-or-greater)
    - [安装 `.Net` 环境](#安装-net-环境)
    - [安装 `c++`](#安装-c)
  - [python 环境安装 `mod_wsgi`](#python-环境安装-mod_wsgi)
  - [部署 Django](#部署-django)

## 介绍

- 开发环境
  - 可以只安装 Django ，Django 包含一个可用于测试的轻量级 Web 服务器
- 生产环境
  - 需要安装 Apache 和 mod_wsgi（需要安装 c++ 才能用）。
    - 安装 Apache
    - 安装 microsoft visual c++ 14.0 or greater
    - 安装 mod_wsgi

## 安装 Apache

[安装流程参考](https://blog.csdn.net/qq_43003203/article/details/105360543)

[Apache 官网](https://httpd.apache.org/)

1. 去官网点击 `Download`，点击 `Files for Microsoft Windows`，点击 `Apache Lounge`
2. 下载 zip 文件，文件格式类似 `httpd-2.4.62-240904-win64-VS17.zip`
3. 解压 zip 文件
4. 将 Apache24 文件夹放到 `C:\` 下。`C:\Apache24` 是默认的位置，如果放在其他文件夹需要更改 `.conf` 文件的设置
5. 打开 `C:\Apache24\conf\httpd.conf` 文件，修改 listen 后面的端口号，改成不容易被别的进程占用的端口
6. 以管理员身份运行 cmd（搜索 cmd，然后右键点击 run as administrator）
7. 输入下面的命令，安装 Apache，然后启动 Apache

    ```bat
    cd C:\Apache24\bin
    httpd -k install
    httpd -k start
    ```

8. 打开浏览器，访问 `localhost:xxxx` ，如果有 `It work` 代表安装成功
   - 默认监听 4200 端口。在 `Apache24\conf\httpd.conf` 配置文件可以看到监听了哪个端口

## 安装 microsoft visual c++ 14.0 or greater

### 安装 `.Net` 环境

如果电脑没有 `.Net` 环境，安装 `.Net` 环境

1. 访问 [下载地址](https://dotnet.microsoft.com/zh-cn/download/visual-studio-sdks)
2. 看到 `.NET Framework`，选择需要的版本，点击**开发者工具包(developer pack)**，进行下载
3. 运行 exe ，进行安装。然后重启电脑，不然不会生效

### 安装 `c++`

安装 `c++` 。实际是安装 **使用 C++ 的桌面开发** 的内容

1. 可以通过安装 `visual studio` 来安装
   1. 在安装 `visual studio` 时勾选上 **使用 C++ 的桌面开发**
   2. 最好安装 `visual studio` 时一起安装 **使用 C++ 的桌面开发** 的内容
2. 可以单独安装
   1. 到下载 visual studio 的[地方](https://visualstudio.microsoft.com/downloads/)
   2. 往下浏览，点击 `Tools for Visual Studio`，下载 `Build Tools for Visual Studio 2022`
   3. 运行下载的文件，选择 **使用 C++ 的桌面开发**，然后安装

## python 环境安装 `mod_wsgi`

直接 `pip install mod_wsgi`

> conda-forge 没有 mod_wsgi 这个包，用 pip install

## 部署 Django

[如何使用 Apache 和 mod_wsgi 托管 Django](https://docs.djangoproject.com/zh-hans/5.1/howto/deployment/wsgi/modwsgi/)

1、在 conda 环境下运行下面的命令导出加载 `wsgi_module` 的配置

```sh
mod_wsgi-express module-config
```

2、将输出的内容粘贴到 Apache 的 `httpd.conf` 文件中

```conf
LoadFile "C:/Users/.../AppData/Local/miniforge3/envs/django_rest_test/python311.dll"
LoadModule wsgi_module "C:/Users/.../AppData/Local/miniforge3/envs/django_rest_test/Lib/site-packages/mod_wsgi/server/mod_wsgi.cp311-win_amd64.pyd"
WSGIPythonHome "C:/Users/.../AppData/Local/miniforge3/envs/django_rest_test"
```

> 注意：路径如果有 `-`，那么路径要用 `""` 框住

3、在 `httpd.conf` 添加下面的内容

```conf
WSGIScriptAlias / /path/to/mysite.com/mysite/wsgi.py
WSGIPythonHome /path/to/venv

<Directory /path/to/mysite.com/mysite>
<Files wsgi.py>
Require all granted
</Files>
</Directory>
```

- `WSGIScriptAlias`
  - 语法：`WSGIScriptAlias / /path/to/mysite/mysite/wsgi.py`
  - 第一项是你所期望的应用所在的基础 URL 路径（ `/` 根 url）
  - 第二项是 "WSGI 文件" 的位置，一般位于项目包之内。这告诉 Apache 用该文件中定义的 WSGI 应用响应指定 URL 下的请求。
- `WSGIPythonPath`
  - 确保你的项目包能从 `Python path` 导入；换句话说， `import mysite` 能正常工作。
- `<Directory>` 块确保 `Apache` 有权访问 `WSGI` 文件。
- `<Files>` 块确保只有被授权的用户可以访问 `wsgi.py` 文件。

4、重启 Appache

```sh
C:\Apache24\bin>httpd -k restart 
```
