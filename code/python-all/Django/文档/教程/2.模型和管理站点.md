# 模型和管理站点

- [模型和管理站点](#模型和管理站点)
  - [数据库配置](#数据库配置)
  - [创建模型](#创建模型)
  - [激活模型](#激活模型)
  - [初试 API](#初试-api)
  - [介绍 Django 管理页面](#介绍-django-管理页面)
    - [创建一个管理员账号](#创建一个管理员账号)
    - [启动开发服务器](#启动开发服务器)
    - [向管理页面中加入投票应用](#向管理页面中加入投票应用)

## 数据库配置

通常， INSTALLED_APPS 默认包括了以下 Django 的自带应用：

- django.contrib.admin -- 管理员站点。
- django.contrib.auth -- 认证授权系统。
- django.contrib.contenttypes -- 内容类型框架。
- django.contrib.sessions -- 会话框架。
- django.contrib.messages -- 消息框架。
- django.contrib.staticfiles -- 管理静态文件的框架。

默认开启的某些应用需要至少一个数据表，所以，在使用他们之前需要在数据库中创建一些表。请执行以下命令：

```text
python manage.py migrate
```

这个 `migrate` 命令查看 `INSTALLED_APPS` 配置，并根据 `mysite/settings.py` 文件中的数据库配置和随应用提供的数据库迁移文件，创建任何必要的数据库表。

## 创建模型

编辑 polls/models.py 文件，创建 Question 和 Choice 两个模型

```py
from django.db import models


class Question(models.Model):
    question_text = models.CharField(max_length=200)
    pub_date = models.DateTimeField("date published")


class Choice(models.Model):
    question = models.ForeignKey(Question, on_delete=models.CASCADE)
    choice_text = models.CharField(max_length=200)
    votes = models.IntegerField(default=0)
```

- 每个模型被表示为 `django.db.models.Model` 类的子类。
- 每个字段都是 `Field` 类的实例

## 激活模型

把 `polls` 应用安装到我们的项目里，我们需要在配置类 `INSTALLED_APPS` 中添加设置。

因为 `PollsConfig` 类写在文件 `polls/apps.py` 中，所以它的点式路径是 `'polls.apps.PollsConfig'`。

在文件 `mysite/settings.py` 中 `INSTALLED_APPS` 子项添加点式路径后，它看起来像这样：

```py
# mysite/settings.py
INSTALLED_APPS = [
    "polls.apps.PollsConfig",
    "django.contrib.admin",
    "django.contrib.auth",
    "django.contrib.contenttypes",
    "django.contrib.sessions",
    "django.contrib.messages",
    "django.contrib.staticfiles",
]
```

现在你的 `Django` 项目会包含 `polls` 应用。接着运行下面的命令：

```text
python manage.py makemigrations polls
```

通过运行 `makemigrations` 命令，`Django` 会检测你对模型文件的修改，并且把修改的部分储存为一次 迁移。

迁移是 `Django` 对于模型定义（也就是你的数据库结构）的变化的储存形式 - 它们其实也只是一些你磁盘上的文件。如果你想的话，你可以阅读一下你模型的迁移数据，它被储存在 `polls/migrations/0001_initial.py` 里。

现在，再次运行 `migrate` 命令，在数据库里创建新定义的模型的数据表：

```text
$ python manage.py migrate
Operations to perform:
  Apply all migrations: admin, auth, contenttypes, polls, sessions
Running migrations:
  Rendering model states... DONE
  Applying polls.0001_initial... OK
```

**改变模型需要这三步**：

- 编辑 `models.py` 文件，改变模型。
- 运行 `python manage.py makemigrations` 为模型的改变生成迁移文件。
- 运行 `python manage.py migrate` 来应用数据库迁移。

## 初试 API

使用交互式 Python 命令行，尝试一下 Django 为你创建的各种 API。

```shell
$ python manage.py shell

>>> from polls.models import Choice, Question  # Import the model classes we just wrote.

# No questions are in the system yet.
>>> Question.objects.all()
<QuerySet []>
```

要退出这个 shell，你只需在命令行中输入 `exit()` 或按下 `Ctrl+D`（在 Unix 系统中）或 `Ctrl+Z` 然后回车（在 Windows 系统中）。这将关闭交互式 shell，回到你执行 `manage.py` 命令的终端中。

## 介绍 Django 管理页面

### 创建一个管理员账号

首先，我们得创建一个能登录管理页面的用户。请运行下面的命令：

```text
python manage.py createsuperuser
```

然后输入用户名、邮件地址和密码

### 启动开发服务器

使用以下命令启动：

```text
python manage.py runserver
```

现在，打开浏览器，访问 `http://127.0.0.1:8000/admin/` 。你应该会看见管理员登录界面

### 向管理页面中加入投票应用

打开 polls/admin.py 文件，把它编辑成下面这样：

```py
# polls/admin.py
from django.contrib import admin

from .models import Question

admin.site.register(Question)
```
