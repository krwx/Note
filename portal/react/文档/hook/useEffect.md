- [useEffect](#useeffect)
  - [åŸç†](#åŸç†)
  - [`useLayoutEffect` ä¸ `useEffect` çš„åŒºåˆ«:](#uselayouteffect-ä¸-useeffect-çš„åŒºåˆ«)
  - [ä¼ é€’ä¾èµ–æ•°ç»„ã€ç©ºæ•°ç»„å’Œä¸ä¼ é€’ä¾èµ–é¡¹ä¹‹é—´çš„åŒºåˆ«](#ä¼ é€’ä¾èµ–æ•°ç»„ç©ºæ•°ç»„å’Œä¸ä¼ é€’ä¾èµ–é¡¹ä¹‹é—´çš„åŒºåˆ«)
  - [è¯­æ³•](#è¯­æ³•)
  - [ç”¨æ³•](#ç”¨æ³•)
    - [è¿æ¥åˆ°å¤–éƒ¨ç³»ç»Ÿ](#è¿æ¥åˆ°å¤–éƒ¨ç³»ç»Ÿ)
    - [åœ¨è‡ªå®šä¹‰ Hook ä¸­å°è£… Effect](#åœ¨è‡ªå®šä¹‰-hook-ä¸­å°è£…-effect)
    - [åœ¨ Effect ä¸­æ ¹æ®å…ˆå‰ state æ›´æ–° state](#åœ¨-effect-ä¸­æ ¹æ®å…ˆå‰-state-æ›´æ–°-state)


# useEffect

## åŸç†
æ‰€ä»¥æ•´ä¸ªuseEffectå¼‚æ­¥è°ƒç”¨åˆ†ä¸ºä¸‰æ­¥ï¼š
1. before mutationé˜¶æ®µåœ¨scheduleCallbackä¸­è°ƒåº¦flushPassiveEffects
2. layouté˜¶æ®µä¹‹åå°†effectListèµ‹å€¼ç»™rootWithPendingPassiveEffects
3. scheduleCallbackè§¦å‘flushPassiveEffectsï¼ŒflushPassiveEffectså†…éƒ¨éå†rootWithPendingPassiveEffects

## `useLayoutEffect` ä¸ `useEffect` çš„åŒºåˆ«:
* `useLayoutEffect hook` ä» `mutation` é˜¶æ®µçš„é”€æ¯å‡½æ•°è°ƒç”¨åˆ° `layout` é˜¶æ®µçš„å›è°ƒå‡½æ•°è°ƒç”¨æ˜¯åŒæ­¥æ‰§è¡Œçš„ã€‚
* è€Œ `useEffect` åˆ™éœ€è¦å…ˆåœ¨ `before mutation` é˜¶æ®µè°ƒåº¦ï¼Œåœ¨ `Layout` é˜¶æ®µå®Œæˆåå†å¼‚æ­¥æ‰§è¡Œ

1. è§¦å‘æ—¶æœºï¼š  
   - `useEffect`ï¼š`useEffect`æ˜¯åœ¨ç»„ä»¶å®Œæˆæ¸²æŸ“ä¹‹å(åŒ…æ‹¬é¦–æ¬¡æ¸²æŸ“å’Œæ›´æ–°æ¸²æŸ“)å¼‚æ­¥è§¦å‘çš„ã€‚å®ƒä¸ä¼šé˜»å¡ç»„ä»¶çš„æ¸²æŸ“è¿‡ç¨‹ã€‚  
   - `useLayoutEffect`ï¼š`useLayoutEffect`æ˜¯åœ¨ç»„ä»¶å®Œæˆæ¸²æŸ“ä¹‹åã€æµè§ˆå™¨æ‰§è¡Œç»˜åˆ¶ä¹‹å‰åŒæ­¥è§¦å‘çš„ã€‚å®ƒä¼šåœ¨DOMæ›´æ–°ä¹‹å‰è¢«è°ƒç”¨ï¼Œå¯ä»¥é˜»å¡ç»„ä»¶çš„æ¸²æŸ“è¿‡ç¨‹ã€‚
2. æ‰§è¡Œæ—¶é—´ç‚¹ï¼š  
   - `useEffect`ï¼š`useEffect`çš„å‰¯ä½œç”¨æ“ä½œæ˜¯åœ¨ç»„ä»¶æ¸²æŸ“å®Œæˆåçš„"æäº¤é˜¶æ®µ"æ‰§è¡Œçš„ã€‚è¿™æ„å‘³ç€å®ƒä¼šåœ¨æµè§ˆå™¨å®Œæˆç»˜åˆ¶åæ‰§è¡Œï¼Œå¯¹ç”¨æˆ·å¯è§æ€§æ²¡æœ‰ç›´æ¥å½±å“ã€‚  
   - `useLayoutEffect`ï¼š`useLayoutEffect`çš„å‰¯ä½œç”¨æ“ä½œæ˜¯åœ¨ç»„ä»¶æ¸²æŸ“å®Œæˆåçš„"å¸ƒå±€é˜¶æ®µ"æ‰§è¡Œçš„ã€‚è¿™æ„å‘³ç€å®ƒä¼šåœ¨æµè§ˆå™¨æ‰§è¡Œç»˜åˆ¶ä¹‹å‰æ‰§è¡Œï¼Œå¯¹DOMçš„è®¡ç®—å’Œå¸ƒå±€æœ‰ç›´æ¥å½±å“ã€‚å› æ­¤ï¼Œ`useLayoutEffect`ä¸­çš„å‰¯ä½œç”¨æ“ä½œä¼šåœ¨æµè§ˆå™¨æ›´æ–°å±å¹•ä¹‹å‰åŒæ­¥è§¦å‘ã€‚

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç”±äº`useLayoutEffect`çš„åŒæ­¥ç‰¹æ€§ï¼Œå¦‚æœåœ¨ä½¿ç”¨`useLayoutEffect`æ—¶è¿›è¡Œå¤§é‡è®¡ç®—æˆ–é˜»å¡æ“ä½œï¼Œå¯èƒ½ä¼šå¯¼è‡´ç”¨æˆ·ç•Œé¢çš„å¡é¡¿å’Œä¸å“åº”ã€‚å› æ­¤ï¼Œä¸€èˆ¬æƒ…å†µä¸‹æ¨èä½¿ç”¨`useEffect`ï¼Œåªæœ‰åœ¨éœ€è¦åœ¨DOMæ›´æ–°ä¹‹å‰ç«‹å³æ‰§è¡ŒæŸäº›æ“ä½œæ—¶ï¼Œæ‰ä½¿ç”¨`useLayoutEffect`ã€‚

æ€»ç»“ï¼š
- `useEffect`æ˜¯å¼‚æ­¥è§¦å‘ï¼Œé€‚ç”¨äºå¤§å¤šæ•°å‰¯ä½œç”¨æ“ä½œã€‚
- `useLayoutEffect`æ˜¯åŒæ­¥è§¦å‘ï¼Œé€‚ç”¨äºéœ€è¦åœ¨DOMæ›´æ–°ä¹‹å‰ç«‹å³æ‰§è¡Œæ“ä½œçš„æƒ…å†µï¼Œä½†éœ€è¦æ³¨æ„æ½œåœ¨çš„æ€§èƒ½é—®é¢˜ã€‚

## ä¼ é€’ä¾èµ–æ•°ç»„ã€ç©ºæ•°ç»„å’Œä¸ä¼ é€’ä¾èµ–é¡¹ä¹‹é—´çš„åŒºåˆ«
* ä¼ é€’ä¾èµ–é¡¹æ•°ç»„
  * å¦‚æœæŒ‡å®šäº†ä¾èµ–é¡¹ï¼Œåˆ™ Effect åœ¨ **åˆå§‹æ¸²æŸ“åä»¥åŠä¾èµ–é¡¹å˜æ›´çš„é‡æ–°æ¸²æŸ“å** è¿è¡Œã€‚
* ä¼ é€’ç©ºä¾èµ–é¡¹æ•°ç»„ 
  * å¦‚æœä½ çš„ Effect ç¡®å®æ²¡æœ‰ä½¿ç”¨ä»»ä½•å“åº”å¼å€¼ï¼Œåˆ™å®ƒä»…åœ¨ **åˆå§‹æ¸²æŸ“å** è¿è¡Œã€‚
* ä¸ä¼ é€’ä¾èµ–é¡¹æ•°ç»„ 
  * å¦‚æœå®Œå…¨ä¸ä¼ é€’ä¾èµ–æ•°ç»„ï¼Œåˆ™ Effect ä¼šåœ¨ç»„ä»¶çš„ **æ¯æ¬¡å•ç‹¬æ¸²æŸ“ï¼ˆå’Œé‡æ–°æ¸²æŸ“ï¼‰ä¹‹å** è¿è¡Œã€‚


## è¯­æ³•
`useEffect(setup, dependencies?) `
å‚æ•°ï¼š
- setupï¼š
  - å¤„ç† `Effect` çš„å‡½æ•°ã€‚
  - setup å‡½æ•°é€‰æ‹©æ€§è¿”å›ä¸€ä¸ª æ¸…ç†ï¼ˆcleanupï¼‰ å‡½æ•°ã€‚
  - å½“ç»„ä»¶è¢«æ·»åŠ åˆ° DOM çš„æ—¶å€™ï¼ŒReact å°†è¿è¡Œ setup å‡½æ•°ã€‚
  - åœ¨æ¯æ¬¡ä¾èµ–é¡¹å˜æ›´é‡æ–°æ¸²æŸ“åï¼ŒReact å°†é¦–å…ˆä½¿ç”¨æ—§å€¼è¿è¡Œ cleanup å‡½æ•°ï¼ˆå¦‚æœä½ æä¾›äº†è¯¥å‡½æ•°ï¼‰ï¼Œç„¶åä½¿ç”¨æ–°å€¼è¿è¡Œ setup å‡½æ•°ã€‚
  - åœ¨ç»„ä»¶ä» DOM ä¸­ç§»é™¤åï¼ŒReact å°†æœ€åä¸€æ¬¡è¿è¡Œ cleanup å‡½æ•°ã€‚
- å¯é€‰ dependenciesï¼š
  - setup ä»£ç ä¸­å¼•ç”¨çš„æ‰€æœ‰å“åº”å¼å€¼çš„åˆ—è¡¨ã€‚
  - å“åº”å¼å€¼åŒ…æ‹¬ propsã€state ä»¥åŠæ‰€æœ‰ç›´æ¥åœ¨ç»„ä»¶å†…éƒ¨å£°æ˜çš„å˜é‡å’Œå‡½æ•°ã€‚
  - ä¾èµ–é¡¹åˆ—è¡¨çš„å…ƒç´ æ•°é‡å¿…é¡»æ˜¯å›ºå®šçš„ï¼Œå¹¶ä¸”å¿…é¡»åƒ `[dep1, dep2, dep3]` è¿™æ ·å†…è”ç¼–å†™ã€‚
  - React å°†ä½¿ç”¨ `Object.is` æ¥æ¯”è¾ƒæ¯ä¸ªä¾èµ–é¡¹å’Œå®ƒå…ˆå‰çš„å€¼ã€‚
  - **å¦‚æœçœç•¥æ­¤å‚æ•°ï¼Œåˆ™åœ¨æ¯æ¬¡é‡æ–°æ¸²æŸ“ç»„ä»¶ä¹‹åï¼Œå°†é‡æ–°è¿è¡Œ Effect å‡½æ•°**ã€‚

æ³¨æ„äº‹é¡¹ï¼š
- `useEffect` æ˜¯ä¸€ä¸ª Hookï¼Œå› æ­¤åªèƒ½åœ¨ ç»„ä»¶çš„é¡¶å±‚ æˆ–è‡ªå·±çš„ Hook ä¸­è°ƒç”¨å®ƒï¼Œè€Œä¸èƒ½åœ¨å¾ªç¯æˆ–è€…æ¡ä»¶å†…éƒ¨è°ƒç”¨ã€‚
- å½“ä¸¥æ ¼æ¨¡å¼å¯åŠ¨æ—¶ï¼ŒReact å°†åœ¨çœŸæ­£çš„ setup å‡½æ•°é¦–æ¬¡è¿è¡Œå‰ï¼Œ**è¿è¡Œä¸€ä¸ªå¼€å‘æ¨¡å¼ä¸‹ä¸“æœ‰çš„é¢å¤– setup + cleanup å‘¨æœŸ**ã€‚
- å¦‚æœä½ çš„ Effect ä¸æ˜¯ç”±äº¤äº’ï¼ˆæ¯”å¦‚ç‚¹å‡»ï¼‰å¼•èµ·çš„ï¼Œé‚£ä¹ˆ React ä¼šè®©æµè§ˆå™¨ **åœ¨è¿è¡Œ Effect å‰å…ˆç»˜åˆ¶å‡ºæ›´æ–°åçš„å±å¹•**ã€‚å¦‚æœä½ çš„ Effect æ­£åœ¨åšä¸€äº›è§†è§‰ç›¸å…³çš„äº‹æƒ…ï¼ˆä¾‹å¦‚ï¼Œå®šä½ä¸€ä¸ª tooltipï¼‰ï¼Œå¹¶ä¸”æœ‰æ˜¾è‘—çš„å»¶è¿Ÿï¼ˆä¾‹å¦‚ï¼Œå®ƒä¼šé—ªçƒï¼‰ï¼Œé‚£ä¹ˆå°† `useEffect` æ›¿æ¢ä¸º `useLayoutEffectã€‚`
- Effect **åªåœ¨å®¢æˆ·ç«¯ä¸Šè¿è¡Œ**ï¼Œåœ¨æœåŠ¡ç«¯æ¸²æŸ“ä¸­ä¸ä¼šè¿è¡Œã€‚

è¿è¡Œè¿‡ç¨‹ï¼š
1. å°†ç»„ä»¶æŒ‚è½½åˆ°é¡µé¢æ—¶ï¼Œå°†è¿è¡Œ `setup` ä»£ç ã€‚
2. é‡æ–°æ¸²æŸ“ ä¾èµ–é¡¹ å˜æ›´çš„ç»„ä»¶åï¼š
   - é¦–å…ˆï¼Œä½¿ç”¨**æ—§çš„** props å’Œ state è¿è¡Œ `cleanup` ä»£ç ã€‚
   - ç„¶åï¼Œä½¿ç”¨**æ–°çš„** props å’Œ state è¿è¡Œ `setup` ä»£ç ã€‚
3. å½“ç»„ä»¶ä»é¡µé¢å¸è½½åï¼Œ `cleanup` ä»£ç  å°†è¿è¡Œæœ€åä¸€æ¬¡ã€‚

## ç”¨æ³•
### è¿æ¥åˆ°å¤–éƒ¨ç³»ç»Ÿ 
æœ‰äº›ç»„ä»¶éœ€è¦ä¸ç½‘ç»œã€æŸäº›æµè§ˆå™¨ API æˆ–ç¬¬ä¸‰æ–¹åº“ä¿æŒè¿æ¥ï¼Œå½“å®ƒä»¬æ˜¾ç¤ºåœ¨é¡µé¢ä¸Šæ—¶ã€‚è¿™äº›ç³»ç»Ÿä¸å— React æ§åˆ¶ï¼Œæ‰€ä»¥ç§°ä¸ºå¤–éƒ¨ç³»ç»Ÿã€‚
```jsx
import { useEffect } from 'react';
import { createConnection } from './chat.js';

function ChatRoom({ roomId }) {
  const [serverUrl, setServerUrl] = useState('https://localhost:1234');

  useEffect(() => {
  	const connection = createConnection(serverUrl, roomId);
    connection.connect();
  	return () => {
      connection.disconnect();
  	};
  }, [serverUrl, roomId]);
  // ...
}
```

### åœ¨è‡ªå®šä¹‰ Hook ä¸­å°è£… Effect 
```jsx
import { useEffect } from 'react';
import { createConnection } from './chat.js';

export function useChatRoom({ serverUrl, roomId }) {
  useEffect(() => {
    const connection = createConnection(serverUrl, roomId);
    connection.connect();
    return () => {
      connection.disconnect();
    };
  }, [roomId, serverUrl]);
}
```

### åœ¨ Effect ä¸­æ ¹æ®å…ˆå‰ state æ›´æ–° state 
å½“ä½ æƒ³è¦åœ¨ Effect ä¸­æ ¹æ®å…ˆå‰çš„ state æ›´æ–° state æ—¶ï¼Œä½ å¯èƒ½ä¼šé‡åˆ°é—®é¢˜ï¼š
```js
function Counter() {
  const [count, setCount] = useState(0);

  useEffect(() => {
    const intervalId = setInterval(() => {
      setCount(count + 1); // ä½ æƒ³è¦æ¯ç§’é€’å¢è¯¥è®¡æ•°å™¨...
    }, 1000)
    return () => clearInterval(intervalId);
  }, [count]); // ğŸš© ... ä½†æ˜¯æŒ‡å®š `count` ä½œä¸ºä¾èµ–é¡¹æ€»æ˜¯é‡ç½®é—´éš”å®šæ—¶å™¨ã€‚
  // ...
}
```
å› ä¸º count  æ˜¯ä¸€ä¸ªå“åº”å¼å€¼ï¼Œæ‰€ä»¥å¿…é¡»åœ¨ä¾èµ–é¡¹åˆ—è¡¨ä¸­æŒ‡å®šå®ƒã€‚ä½†æ˜¯ï¼Œè¿™ä¼šå¯¼è‡´ Effect åœ¨æ¯æ¬¡ count æ›´æ”¹æ—¶å†æ¬¡æ‰§è¡Œ cleanup å’Œ setupã€‚è¿™å¹¶ä¸ç†æƒ³ã€‚

**è§£å†³æ–¹æ³•ï¼šå‘ setState() ä¼ é€’æ›´æ–°å‡½æ•°**
```js
import { useState, useEffect } from 'react';

export default function Counter() {
  const [count, setCount] = useState(0);

  useEffect(() => {
    const intervalId = setInterval(() => {
      setCount(c => c + 1); // âœ… ä¼ é€’ä¸€ä¸ª state æ›´æ–°å™¨
    }, 1000);
    return () => clearInterval(intervalId);
  }, []); // âœ…ç°åœ¨ count ä¸æ˜¯ä¸€ä¸ªä¾èµ–é¡¹

  return <h1>{count}</h1>;
}
```







